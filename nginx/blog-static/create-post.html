<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nuevo Post</title>
  <link href="css/styles.css" rel="stylesheet" />
</head>
<body>
  <!-- Navigation-->
  <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
      <div class="container px-4 px-lg-5">
          <a class="navbar-brand" href="index.html">Este Blog</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
              Menu
              <i class="fas fa-bars"></i>
          </button>
          <div class="collapse navbar-collapse" id="navbarResponsive">
              <ul class="navbar-nav ms-auto py-4 py-lg-0">
                  <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Inicio</a></li>
                  <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="about.html">Acerca de</a></li>
                  <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="create-post.html">Nuevo Post</a></li>
                  <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="contact.html">Contacto</a></li>
                  <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a></li>
              </ul>
          </div>
      </div>
    </nav>

  <header class="masthead" style="background-image: url('assets/img/post-bg.jpg')">
    <div class="container text-center text-white py-5">
      <h1>Crear Nuevo Post</h1>
      <p>Subí texto e imagen y publicalo en tu blog</p>
    </div>
  </header>

  <main class="container my-5">
    <form id="postForm" enctype="multipart/form-data">
      <div class="form-floating mb-3">
        <input type="text" class="form-control" id="title" name="title" placeholder="Título" required>
        <label for="title">Título</label>
      </div>
      <div class="form-floating mb-3">
        <input type="text" class="form-control" id="slug" name="slug" placeholder="slug-post" required>
        <label for="slug">Slug</label>
      </div>
      <div class="form-floating mb-3">
        <select class="form-select" id="category" name="category" required>
        <option value="">Seleccioná una categoría</option>
        </select>
        <label for="category">Categoría</label>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="published" name="published">
        <label class="form-check-label" for="published">
            Publicar
        </label>
     </div>
      <div class="form-floating mb-3">
        <textarea class="form-control" id="content" name="content" placeholder="Contenido" style="height: 150px" required></textarea>
        <label for="content">Contenido</label>
      </div>
      <div class="mb-3">
        <label for="miniature" class="form-label">Imagen Miniatura</label>
        <input class="form-control" type="file" id="miniature" name="miniature" accept="image/*">
      </div>
      <button type="submit" class="btn btn-primary">Publicar</button>
      <div id="statusMessage" class="mt-3"></div>
    </form>
  <!-- Modal de Login -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="login-form">
            <div class="mb-3">
              <label for="login-email" class="form-label">Email</label>
              <input type="email" class="form-control" id="login-email" required>
            </div>
            <div class="mb-3">
              <label for="login-password" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="login-password" required>
            </div>
            <div class="text-end">
              <button type="submit" class="btn btn-primary">Ingresar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <script src="js/scripts.js"></script>
  <script type="module">
  import { login, getEmailFromToken } from './js/auth.js';

  // LOGIN
  document.getElementById('login-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    await login(email, password);
    const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
    modal.hide();
  });

  // SUBMIT DEL FORMULARIO DE POST
  document.getElementById("postForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const token = localStorage.getItem("access_token");
    if (!token) {
      document.getElementById("statusMessage").innerHTML = '<div class="alert alert-warning">Debes iniciar sesión.</div>';
      return;
    }

    const form = document.getElementById("postForm");
    const formData = new FormData(form);

    // Agregar published (checkbox booleano como string)
    formData.set("published", document.getElementById("published").checked ? "true" : "false");

    // Agregar email desde el JWT
    const email = getEmailFromToken();
    if (email) {
      formData.set("email", email);
    }
    console.log(email)
    try {
      const response = await fetch("/api/posts/", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        },
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        document.getElementById("statusMessage").innerHTML = '<div class="alert alert-success">¡Post creado!</div>';
        form.reset();
      } else {
        document.getElementById("statusMessage").innerHTML = '<div class="alert alert-danger">Error: ' + JSON.stringify(result) + '</div>';
      }
    } catch (error) {
      document.getElementById("statusMessage").innerHTML = '<div class="alert alert-danger">Fallo al conectar con el servidor.</div>';
    }
  });

  // CARGA DINÁMICA DE CATEGORÍAS
  async function cargarCategorias() {
    try {
      const res = await fetch("/api/categories/");
      const categorias = await res.json();

      const select = document.getElementById("category");
      categorias.forEach(cat => {
        if (cat.published) {
          const option = document.createElement("option");
          option.value = cat.id;
          option.textContent = cat.title;
          select.appendChild(option);
        }
      });
    } catch (e) {
      console.error("Error al cargar categorías", e);
    }
  }

  cargarCategorias();

  </script>
  
  </main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
